<project name="Poedit dependencies" default="compile">

    <description>
    Builds all Poedit's 3rd party dependencies needed on current platform.
    Usage: just run `ant`.
    </description>

    <condition property="is_osx">
        <os family="mac"/>
    </condition>
    <condition property="os.nickname" value="osx">
        <os family="mac"/>
    </condition>
    <condition property="is_windows">
        <os family="windows"/>
    </condition>
    <condition property="os.nickname" value="win">
        <os family="windows"/>
    </condition>

    <condition property="cflags.optimize" value="-O2" else="-O2">
        <equals arg1="${config}" arg2="Release"/>
    </condition>
    <condition property="cflags.debug" value="" else="-ggdb3">
        <equals arg1="${config}" arg2="Release"/>
    </condition>

    <property environment="env"/>
    <property file="build.local.properties"/>
    <property file="build.properties"/>

    <pathconvert property="basedir.unix" targetos="unix">
        <path location="${basedir}"/>
    </pathconvert>
    <pathconvert property="builddir.unix" targetos="unix">
        <path location="${builddir}"/>
    </pathconvert>

    <property name="gettextdir" value="${builddir.unix}/gettext"/>

    <target name="info">
        <echo message="Platform:   ${os.name} (${os.nickname})"/>
        <echo message="Builddir:   ${builddir}"/>
    </target>

    <target name="clean"
            description="clean compiled binary files">
        <delete dir="${builddir}"/>
    </target>


    <target name="compile"
            description="compile all dependencies for building on this platform"
            depends="compile-gettext,compile-db,compile-wx,compile-win-sparkle">
    </target>

    <target name="compile-gettext" depends="win-gettext,osx-gettext"
            description="compile GNU gettext"/>
    <target name="compile-db" depends="win-db,osx-db"
            description="compile Berkeley DB"/>
    <target name="compile-wx" depends="win-wx"
            description="compile wxWidgets"/>
    <target name="compile-win-sparkle" depends="win-sparkle"
            description="compile WinSparkle"/>


<!-- ==============================================================
     Windows dependencies - GNU gettext
     ============================================================== -->

     <target name="mingw-dlls" if="is_windows">
       <copy file="${mingw.bindir}/libgcc_s_dw2-1.dll" todir="${gettextdir}/bin"/>
       <copy file="${mingw.bindir}/libstdc++-6.dll" todir="${gettextdir}/bin"/>
       <copy file="${mingw.bindir}/libgomp-1.dll" todir="${gettextdir}/bin"/>
       <copy file="${mingw.bindir}/pthreadGC2.dll" todir="${gettextdir}/bin"/>
    </target>

    <target name="win-libiconv-check" if="is_windows">
        <echo level="info" message="Checking if libiconv needs building..."/>
        <dependset>
            <srcfileset dir="libiconv"
                excludes="builddir/**,**/aclocal.m4,**/config.h.in,**/Makefile.in,**/configure"/>
            <targetfileset dir="${gettextdir}" includes="bin/*iconv*,bin/*charset*"/>
            <targetfileset dir="${gettextdir}" includes="lib/*iconv*,lib/*charset*"/>
            <targetfilelist files="${gettextdir}/built.libiconv"/>
        </dependset>
        <available property="built.libiconv" file="${gettextdir}/built.libiconv"/>
    </target>

    <target name="win-libiconv" depends="win-libiconv-check" unless="built.libiconv" if="is_windows">
        <echo level="info" message="Building libiconv DLL..."/>
        <!-- Prevent automake regeneration: -->
        <touch>
            <fileset dir="gettext" includes="**/aclocal.m4"/>
            <fileset dir="gettext" includes="**/config.h.in"/>
            <fileset dir="libiconv" includes="**/Makefile.in"/>
            <fileset dir="libiconv" includes="**/configure"/>
        </touch>
        <mkdir dir="${gettextdir}"/>
        <mkdir dir="libiconv/builddir"/>
        <exec dir="libiconv/builddir" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="../configure"/>
            <arg value="--prefix=${gettextdir}"/>
            <arg value="--disable-static"/>
            <arg value="CFLAGS=${msys.env.CFLAGS}"/>
            <arg value="CXXFLAGS=${msys.env.CFLAGS}"/>
        </exec>
        <exec dir="libiconv/builddir" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="make install -j1"/>
        </exec>
        <exec dir="${gettextdir}/bin" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="strip *.dll"/>
        </exec>
        <touch file="${gettextdir}/built.libiconv"/>
    </target>

    <target name="win-gettext-check" if="is_windows">
        <echo level="info" message="Checking if GNU gettext needs building..."/>
        <dependset>
            <!-- NB: gnulib-lib is excluded, because some sources
                     are regenerated and I can't figure out how to fix it -->
            <srcfileset dir="gettext" excludes="builddir/**,gettext-tools/gnulib-lib/**,**/aclocal.m4,**/config.h.in,**/Makefile.in,**/configure,gettext-tools/doc/stamp-vti,gettext-tools/examples/**"/>
            <targetfileset dir="${gettextdir}" includes="bin/*gettext*"/>
            <targetfileset dir="${gettextdir}" includes="bin/msg*.exe"/>
            <targetfilelist files="${gettextdir}/built.gettext"/>
        </dependset>
        <available property="built.gettext" file="${gettextdir}/built.gettext"/>
    </target>

    <target name="win-gettext" depends="win-libiconv,mingw-dlls,win-gettext-check" unless="built.gettext" if="is_windows">
        <echo level="info" message="Building GNU gettext..."/>
        <!-- Prevent automake regeneration: -->
        <touch>
            <fileset dir="gettext" includes="**/aclocal.m4"/>
            <fileset dir="gettext" includes="**/config.h.in"/>
            <fileset dir="gettext" includes="**/Makefile.in"/>
            <fileset dir="gettext" includes="**/configure"/>
        </touch>
        <touch file="gettext/gettext-tools/doc/stamp-vti"/>
        <mkdir dir="${gettextdir}"/>
        <mkdir dir="gettext/builddir"/>
        <exec dir="gettext/builddir" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="../configure"/>
            <arg value="--prefix=${gettextdir}"/>
            <arg value="--with-libiconv-prefix=${gettextdir}"/>
            <arg value="--enable-threads=win32"/>
            <arg value="--disable-static"/>
            <arg value="--disable-java"/>
            <arg value="--disable-rpath"/>
            <arg value="CFLAGS=${msys.env.CFLAGS}"/>
            <arg value="CXXFLAGS=${msys.env.CFLAGS}"/>
        </exec>
        <touch file="gettext/builddir/gettext-tools/misc/archive.dir.tar.gz"/>
        <touch file="gettext/builddir/gettext-tools/misc/archive.git.tar.gz"/>
        <touch file="gettext/builddir/gettext-tools/misc/archive.cvs.tar.gz"/>
        <exec dir="gettext/builddir" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="make"/>
        </exec>
        <exec dir="gettext/builddir" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="make install -j1"/>
        </exec>
        <exec dir="${gettextdir}/bin" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="strip *.dll *.exe"/>
        </exec>
        <touch file="${gettextdir}/built.gettext"/>
    </target>



<!-- ==============================================================
     Windows dependencies - Berkeley DB
     ============================================================== -->

     <target name="win-db-check" if="is_windows">
        <echo level="info" message="Checking if Berkeley DB needs building..."/>
        <dependset>
            <srcfileset dir="db" excludes="build_windows/Win32/**,build_unix/**,csharp/**,docs/**,examples*/**,java/**,perl/**,tcl/**,test*/**"/>
            <targetfileset dir="db/build_windows/Win32"/>
        </dependset>
        <available property="built.win-db" file="db/build_windows/Win32/Release/libdb48.dll"/>
    </target>

    <target name="win-db" depends="win-db-check" unless="built.win-db" if="is_windows">
        <echo level="info" message="Building Berkeley DB..."/>
        <copy file="db/build_windows/db.vcproj" tofile="db/build_windows/db_my.vcproj"/>
        <exec dir="db/build_windows" executable="${msvs.vcbuild}" failonerror="true">
            <arg value="/upgrade"/>
            <arg value="db_my.vcproj"/>
        </exec>
        <exec dir="db/build_windows" executable="${msvs.vcbuild}" failonerror="true">
            <arg value="/platform:Win32"/>
            <arg value="db_my.vcproj"/>
            <arg value="Release"/>
        </exec>
        <delete>
            <fileset dir="db/build_windows" includes="db_my.*"/>
        </delete>
    </target>


<!-- ==============================================================
     Windows dependencies - WinSparkle
     ============================================================== -->

     <target name="win-sparkle-check" if="is_windows">
        <echo level="info" message="Checking if WinSparkle needs building..."/>
        <dependset>
            <srcfileset dir="winsparkle" excludes="**/Release*/**"/>
            <targetfileset dir="winsparkle" includes="Release/*"/>
        </dependset>
        <available property="built.win-sparkle" file="winsparkle/Release/WinSparkle.dll"/>
    </target>

    <target name="win-sparkle" depends="win-sparkle-check" unless="built.win-sparkle" if="is_windows">
        <echo level="info" message="Building WinSparkle..."/>
        <exec dir="winsparkle/3rdparty" executable="${msvs.vcbuild}" failonerror="true">
            <arg value="/platform:Win32"/>
            <arg value="WinSparkleDeps.sln"/>
            <arg value="Release|Win32"/>
        </exec>
        <exec dir="winsparkle" executable="${msvs.vcbuild}" failonerror="true">
            <arg value="/platform:Win32"/>
            <arg value="WinSparkle.sln"/>
            <arg value="Release|Win32"/>
        </exec>
    </target>



<!-- ==============================================================
     Windows dependencies - wxWidgets
     ============================================================== -->

     <target name="win-wx-check" if="is_windows">
        <echo level="info" message="Checking if wxWidgets needs building..."/>
        <dependset>
            <srcfileset dir="wx" includes="include/**,src/**" excludes="include/wx/msw/setup.h"/>
            <targetfileset dir="wx" includes="lib/vc_lib/*"/>
            <targetfileset dir="wx/locale/*.mo"/>
        </dependset>
        <available property="built.win-wx" file="wx/lib/vc_lib/wxmsw29u_core.lib"/>
    </target>

    <target name="win-wx" depends="win-gettext,win-wx-check" unless="built.win-wx" if="is_windows">
        <echo level="info" message="Building wxWidgets..."/>
        <exec dir="." executable="${msvs.vcbuild}" failonerror="true">
            <arg value="/platform:Win32"/>
            <arg value="wxWidgetsForPoedit.vcproj"/>
            <arg value="Release"/>
        </exec>
        <exec dir="wx/locale" executable="${msys.sh}" failonerror="true">
            <env key="PATH" path="${msys.env.PATH}"/>
            <arg value="-c"/>
            <arg value="make allmo MSGFMT=${gettextdir}/bin/msgfmt.exe"/>
        </exec>
    </target>


<!-- ==============================================================
     OS X dependencies - misc helpers
     ============================================================== -->

     <!-- merge 2 arch binaries into one fat one -->
     <macrodef name="merge-archs-2">
         <attribute name="prefix"/>
         <attribute name="dir"/>
         <attribute name="file"/>
         <sequential>
             <echo level="info" message="merging archs into universal binary @{prefix}/@{dir}/@{file}"/>
             <mkdir dir="@{prefix}/@{dir}"/>
             <exec dir="@{prefix}" executable="lipo" failonerror="true">
                 <arg value="-arch"/>
                 <arg value="i386"/>
                 <arg value="i386/@{dir}/@{file}"/>
                 <arg value="-arch"/>
                 <arg value="x86_64"/>
                 <arg value="x86_64/@{dir}/@{file}"/>
                 <arg value="-create"/>
                 <arg value="-output"/>
                 <arg value="@{dir}/@{file}"/>
             </exec>
             <exec dir="@{prefix}" executable="strip" failonerror="true">
                 <arg value="-u"/>
                 <arg value="-r"/>
                 <arg value="@{dir}/@{file}"/>
             </exec>
         </sequential>
     </macrodef>

     <macrodef name="strip-exe">
         <attribute name="file"/>
         <sequential>
             <echo level="info" message="stripping @{file}"/>
             <exec executable="/usr/bin/strip" failonerror="true">
                 <arg value="-u"/>
                 <arg value="-r"/>
                 <arg value="@{file}"/>
             </exec>
         </sequential>
     </macrodef>

     <macrodef name="strip-dylib">
         <attribute name="file"/>
         <sequential>
             <echo level="info" message="stripping @{file}"/>
             <exec executable="/usr/bin/strip" failonerror="true">
                 <arg value="-x"/>
                 <arg value="@{file}"/>
             </exec>
         </sequential>
     </macrodef>


<!-- ==============================================================
     OS X dependencies - Berkeley DB
     ============================================================== -->

     <target name="osx-db-check" if="is_osx">
        <echo level="info" message="Checking if Berkeley DB needs building..."/>
        <dependset>
            <srcfileset dir="db" excludes="build_unix/**,csharp/**,docs/**,examples*/**,java/**,perl/**,tcl/**,test*/**"/>
            <targetfileset dir="${builddir}/db"/>
            <targetfilelist files="${intdir}/db.buildtag"/>
        </dependset>
        <available property="built.osx-db" file="${intdir}/db.buildtag"/>
    </target>

    <target name="osx-db-arch">
        <echo level="info" message="Building Berkeley DB for ${osx.arch}..."/>
        <property file="macosx.properties"/>
        <mkdir dir="${intdir}/db/${osx.arch}"/>
        <exec dir="${intdir}/db/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="${basedir}/db/dist/configure"/>
            <arg value="--prefix=${builddir}/db/${osx.arch}"/>
            <arg value="CC=${osx.cc}"/>
            <arg value="CXX=${osx.cxx}"/>
            <arg value="CFLAGS=${osx.cflags}"/>
            <arg value="CXXFLAGS=${osx.cxxflags}"/>
            <arg value="LDFLAGS=${osx.ldflags}"/>
            <arg value="--enable-cxx"/>
            <arg value="--disable-shared"/>
            <arg value="--disable-cryptography"/>
            <arg value="--disable-replication"/>
            <arg value="--disable-statistics"/>
        </exec>
        <exec dir="${intdir}/db/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="-c"/>
            <arg value="make"/>
        </exec>
        <exec dir="${intdir}/db/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="-c"/>
            <arg value="make install -j1"/>
        </exec>
        <delete dir="${builddir}/db/${osx.arch}/docs"/>
    </target>

    <target name="osx-db" depends="osx-db-check" unless="built.osx-db" if="is_osx">
        <antcall target="osx-db-arch">
            <param name="osx.arch" value="i386"/>
            <param name="osx.cc" value="gcc"/>
            <param name="osx.cxx" value="g++"/>
        </antcall>
        <antcall target="osx-db-arch">
            <param name="osx.arch" value="x86_64"/>
            <param name="osx.cc" value="gcc"/>
            <param name="osx.cxx" value="g++"/>
        </antcall>

        <merge-archs-2 prefix="${builddir}/db" dir="lib" file="libdb_cxx.a"/>
        <copy file="${builddir}/db/i386/include/db.h" todir="${builddir}/db/include"/>
        <copy file="${builddir}/db/i386/include/db_cxx.h" todir="${builddir}/db/include"/>

        <touch file="${intdir}/db.buildtag"/>
        <delete dir="${intdir}/db"/>
    </target>


    <!-- ==============================================================
     OS X dependencies - GNU gettext
     ============================================================== -->

     <target name="osx-gettext-check" if="is_osx">
        <echo level="info" message="Checking if GNU gettext needs building..."/>
        <dependset>
            <!-- NB: gnulib-lib is excluded, because some sources
                     are regenerated and I can't figure out how to fix it -->
            <srcfileset dir="gettext" excludes="gettext-tools/gnulib-lib/**,**/aclocal.m4,**/config.h.in,**/Makefile.in,**/configure,gettext-tools/doc/stamp-vti,gettext-tools/examples/**"/>
            <targetfileset dir="${gettextdir}" includes="bin/*"/>
            <targetfilelist files="${intdir}/gettext.buildtag"/>
        </dependset>
        <available property="built.gettext" file="${intdir}/gettext.buildtag"/>
    </target>

    <target name="osx-gettext-arch">
        <echo level="info" message="Building GNU gettext for ${osx.arch}..."/>
        <property file="macosx.properties"/>
        <mkdir dir="${intdir}/gettext/${osx.arch}"/>
        <exec dir="${intdir}/gettext/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="${basedir.unix}/gettext/configure"/>
            <arg value="--prefix=${gettextdir}/${osx.arch}"/>
            <arg value="CC=${osx.cc}"/>
            <arg value="CXX=${osx.cxx}"/>
            <!-- When running configure under Xcode, SIGALRM is ignored and this doesn't play
                 nice with some of the (useless - gnulib) checks, resulting in hanging builds.
                 See http://comments.gmane.org/gmane.comp.lib.gnulib.bugs/13841
                 Let's sabotage the tests by stealing alarm() from them. -->
            <arg value="CFLAGS=${osx.cflags} -Dalarm=alarm_disabled"/>
            <arg value="CXXFLAGS=${osx.cxxflags}"/>
            <arg value="LDFLAGS=${osx.ldflags}"/>
            <arg value="GSED=${osx.gnu.sed}"/>
            <arg value="--with-libiconv-prefix=${osx.sdk.path}/usr"/>
            <!-- Make our life simpler by using static linking and not having to deal with dylibs
                 and install_name_tool. If re-enabling shared builds, don't forget to also add
                 calls to install_name_tool *here*, in osx-gettext-arch, before lipo, because it
                 has to be called on thin, single-arch binaries, it doesn't correctly handle fat
                 ones (only updating the arch it runs on natively). Also consider using @rpath
                 (available since 10.5) instead of @executable_path. -->
            <arg value="--disable-shared"/>
            <arg value="--disable-java"/>
            <arg value="--disable-rpath"/>
        </exec>
        <touch file="${intdir}/gettext/${osx.arch}/gettext-tools/misc/archive.dir.tar.gz"/>
        <touch file="${intdir}/gettext/${osx.arch}/gettext-tools/misc/archive.git.tar.gz"/>
        <touch file="${intdir}/gettext/${osx.arch}/gettext-tools/misc/archive.cvs.tar.gz"/>
        <exec dir="${intdir}/gettext/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="-c"/>
            <arg value="make"/>
        </exec>
        <exec dir="${intdir}/gettext/${osx.arch}" executable="/bin/sh" failonerror="true">
            <arg value="-c"/>
            <arg value="make install -j1"/>
        </exec>
    </target>

    <target name="osx-gettext" depends="osx-gettext-check" unless="built.gettext" if="is_osx">
        <!-- Prevent automake regeneration: -->
        <touch>
            <fileset dir="gettext" includes="**/aclocal.m4"/>
            <fileset dir="gettext" includes="**/config.h.in"/>
            <fileset dir="gettext" includes="**/Makefile.in"/>
            <fileset dir="gettext" includes="**/configure"/>
        </touch>
        <touch file="gettext/gettext-tools/doc/stamp-vti"/>

        <antcall target="osx-gettext-arch">
            <param name="osx.arch" value="i386"/>
        </antcall>
        <antcall target="osx-gettext-arch">
            <param name="osx.arch" value="x86_64"/>
        </antcall>

        <merge-archs-2 prefix="${gettextdir}" dir="bin" file="msgfmt"/>
        <merge-archs-2 prefix="${gettextdir}" dir="bin" file="msgmerge"/>
        <merge-archs-2 prefix="${gettextdir}" dir="bin" file="msgunfmt"/>
        <merge-archs-2 prefix="${gettextdir}" dir="bin" file="msgcat"/>
        <merge-archs-2 prefix="${gettextdir}" dir="bin" file="xgettext"/>

        <!-- TODO: keep dSYM files? -->
        <strip-exe file="${gettextdir}/bin/msgfmt"/>
        <strip-exe file="${gettextdir}/bin/msgmerge"/>
        <strip-exe file="${gettextdir}/bin/msgunfmt"/>
        <strip-exe file="${gettextdir}/bin/msgcat"/>
        <strip-exe file="${gettextdir}/bin/xgettext"/>

        <touch file="${intdir}/gettext.buildtag"/>
        <delete dir="${intdir}/gettext"/>
    </target>

</project>
